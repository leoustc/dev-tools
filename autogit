#!/bin/bash

# Configuration
DEV_BRANCH_NAME="dev"
MAIN_BRANCH="main"
# --- CRITICAL: Define the hidden namespace path ---
HIDDEN_REF_PATH="refs/hidden/${DEV_BRANCH_NAME}"

# ----------------------------------------------------
## üöÄ Push (Commit & Push to Hidden Ref)
# ----------------------------------------------------
# Handles staging, amend/commit, and push to the HIDDEN_REF_PATH
push_dev() {
    LOCAL_DEV_BRANCH="${DEV_BRANCH_NAME}"
    REMOTE_REF="${HIDDEN_REF_PATH}" 
    INITIAL_COMMIT_MSG="Dev Cycle Started: $(date +%Y-%m-%d %H:%M:%S)"

    echo "‚û°Ô∏è Checking out or creating development branch: **${LOCAL_DEV_BRANCH}**"
    
    # Check out the branch. Try to fetch from the hidden ref first to create a local branch if needed.
    if ! git rev-parse --verify ${LOCAL_DEV_BRANCH} >/dev/null 2>&1; then
        if ! git fetch origin "${REMOTE_REF}:${LOCAL_DEV_BRANCH}" >/dev/null 2>&1; then
             # If remote hidden ref doesn't exist (first push), create a local branch from main
             echo "‚ö†Ô∏è Hidden remote ref not found. Creating local branch **${LOCAL_DEV_BRANCH}** from **${MAIN_BRANCH}**."
             git checkout ${MAIN_BRANCH}
             git checkout -b ${LOCAL_DEV_BRANCH} || exit 1
        fi
        echo "‚ú® Started new development cycle on: **${LOCAL_DEV_BRANCH}**"
    fi
    
    git checkout ${LOCAL_DEV_BRANCH} || exit 1
    echo "üîÑ Resuming existing development cycle on: **${LOCAL_DEV_BRANCH}**"

    echo "üèóÔ∏è Staging all local changes..."
    git add .
    
    # Check if the branch has any commits yet
    COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo 0)
    
    if [ "$COMMIT_COUNT" -eq 0 ]; then
        # First commit: Set the initial timestamp message
        echo "üìù Creating initial commit with message: '${INITIAL_COMMIT_MSG}'"
        git commit -m "${INITIAL_COMMIT_MSG}" || { echo "‚ö†Ô∏è No changes to commit."; }
    else
        # Subsequent commits use amend --no-edit to bundle changes without changing the message
        echo "üìù Amending previous commit to hide local history (message preserved)."
        git commit --amend --no-edit || { echo "‚ö†Ô∏è No changes to amend."; }
    fi
    
    # Force push the local branch HEAD to the HIDDEN remote reference
    echo "‚è´ Force pushing changes to hidden remote ref: **${REMOTE_REF}**..."
    git push --force origin "HEAD:${REMOTE_REF}" || exit 1
    
    echo "‚úÖ Development push complete."
}

# ---
## ‚¨áÔ∏è Pull (Sync from Hidden Ref)
# 3) pull_dev: Fetches and checks out the hidden ref

pull_dev() {
    LOCAL_DEV_BRANCH="${DEV_BRANCH_NAME}"
    REMOTE_REF="${HIDDEN_REF_PATH}"

    # Ensure we are not on the branch we are about to delete
    CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
    if [[ "${CURRENT_BRANCH}" == "${LOCAL_DEV_BRANCH}" ]]; then
        echo "‚û°Ô∏è Moving to **${MAIN_BRANCH}** temporarily before deletion..."
        git checkout ${MAIN_BRANCH} || { echo "‚ùå Could not checkout **${MAIN_BRANCH}**."; exit 1; }
    fi

    # Delete the existing local branch if it exists 
    if git rev-parse --verify ${LOCAL_DEV_BRANCH} >/dev/null 2>&1; then
        echo "üóëÔ∏è Deleting existing local branch: **${LOCAL_DEV_BRANCH}**"
        git branch -D ${LOCAL_DEV_BRANCH}
    fi

    echo "‚¨áÔ∏è Fetching and checking out fresh local branch from hidden remote ref: **${REMOTE_REF}**"
    
    # Fetch the specific hidden ref and create a local branch from it
    if git fetch origin "${REMOTE_REF}:${LOCAL_DEV_BRANCH}" >/dev/null 2>&1; then
        git checkout ${LOCAL_DEV_BRANCH}
        echo "‚úÖ Pulled and checked out local branch **${LOCAL_DEV_BRANCH}**."
    else
        echo "‚ùå Remote hidden reference **${REMOTE_REF}** not found. Please run 'git-workflow.sh push' first."
        exit 1
    fi
}

# ---

## üö¢ Release (Merge to Main & Cleanup)

# 4 & 5) release: Squashes the hidden ref into main, and deletes the hidden ref.
release() {
    LOCAL_DEV_BRANCH="${DEV_BRANCH_NAME}"
    REMOTE_REF="${HIDDEN_REF_PATH}"

    # 1. Ensure we are on the main branch
    echo "‚û°Ô∏è Checking out **${MAIN_BRANCH}** branch..."
    git checkout ${MAIN_BRANCH} || exit 1
    git pull origin ${MAIN_BRANCH} # Get latest main before merging

    # 2. Ask user for squashed commit message
    read -p "Enter a **SQUASHED** commit message for the release: " RELEASE_MSG
    
    if [[ -z "${RELEASE_MSG}" ]]; then
        echo "‚ùå Release message cannot be empty. Aborting release."
        exit 1
    fi

    echo "üîÑ Squashing and merging **${LOCAL_DEV_BRANCH}** from hidden ref into **${MAIN_BRANCH}**..."
    
    # Merge the contents of the remote hidden ref into main
    if ! git merge --squash "${REMOTE_REF}"; then
        echo "‚ùå Merge failed. Please resolve conflicts manually and then run 'git commit -m \"$RELEASE_MSG\"' and 'git push'."
        exit 1
    fi
    
    # 3. Commit the squashed merge with the user-provided message
    echo "üìù Committing squashed merge with message: **'${RELEASE_MSG}'**"
    git commit -m "${RELEASE_MSG}" || { echo "‚ö†Ô∏è Nothing to commit (already merged?)."; exit 1; }

    # 4. Push to remote main
    echo "üöÄ Pushing release commit to **origin/${MAIN_BRANCH}**..."
    git push origin ${MAIN_BRANCH} || exit 1
    echo "‚úÖ Release to **${MAIN_BRANCH}** complete."

    # 5. Delete the dev branch (local and HIDDEN remote ref)
    echo "üßπ Deleting local development branch: **${LOCAL_DEV_BRANCH}**"
    git branch -D ${LOCAL_DEV_BRANCH} 
    
    echo "üóëÔ∏è Deleting hidden remote reference: **${REMOTE_REF}**"
    # To delete a custom ref, you push nothing to it:
    git push origin :${REMOTE_REF} || { echo "‚ö†Ô∏è Remote reference may not have existed."; }
    
    echo "üéâ Cleanup complete."
}

if [ $# -eq 0 ]; then
    echo "Usage: $0 {push|pull|release}"
    exit 1
fi

COMMAND="$1"

if [ "${COMMAND}" == "push" ]; then
    push_dev
elif [ "${COMMAND}" == "pull" ]; then
    pull_dev
elif [ "${COMMAND}" == "release" ]; then
    release
else
    echo "Usage: $0 {push|pull|release}"
    exit 1
fi
